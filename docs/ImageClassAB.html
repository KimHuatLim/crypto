<html>
<head>
  <meta charset="UTF-8">
  <title>Image Classification using Feature Extraction with MobileNet. Built with p5.js</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/addons/p5.dom.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.0/addons/p5.sound.min.js"></script>
  <script src="https://unpkg.com/ml5@0.1.3/dist/ml5.min.js" type="text/javascript"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
  }
  
  button {
    margin: 2px;
    padding: 4px;
  }
  video{
    width: 300;
    height: 300;
  }
  p{
    display: inline;
    font-size: 14px;
  }
  h6{
    margin: 4px;
    font-weight: lighter;
    font-size: 14px;
    margin-bottom: 10px;
  }
</style>
</head>

<body>
  <h3>Train a Neural Network to distinguish between class A and Class B</h3>
  <div id="videoContainer"></div>
  <h6><span id="modelStatus">Loading base model...</span> | <span id="videoStatus">Loading video...</span></h6>
  <p>
    <button id="ButtonA">Add A Images</button>
    <p><span id="amountOfAImages">0</span> A Images</p>
    <br><button id="ButtonB">Add B Image</button>
    <p><span id="amountOfBImages">0</span> B Images</p>
  </p>
  <br/>
  <p><button id="train">Train</button><span id="loss"></span></p>
  <br/>
  <p>
    <button id="buttonPredict">Start guessing!</button><br>
    Your custom model labeled this as: <span id="result">...</span>
  </p>
  <br>
  <hr>

<script>
let featureExtractor;
let classifier;
let video;
let loss;
let imagesOfA = 0;
let imagesOfB = 0;
let classificationResult;
let nClassAinARow = 0;
let nClassBinARow = 0;
document.getElementById("train").style.visibility='hidden';
document.getElementById("buttonPredict").style.visibility='hidden';

function setup() {
  createCanvas(640, 480);
  // Create a video element
  video = createCapture(VIDEO);
  video.size(640, 480);
  video.hide();
  // Append it to the videoContainer DOM element
  //video.parent('videoContainer');
  // Extract the already learned features from MobileNet
  featureExtractor = ml5.featureExtractor('MobileNet', modelReady);
  // Create a new classifier using those features and give the video we want to use
  classifier = featureExtractor.classification(video, videoReady);
  // Set up the UI buttons
  setupButtons();
}

function draw() {
  background(122);
  image(video, 0, 0);
  textSize(64);
  if (classificationResult == 'A') {
    nClassAinARow++;
    nClassBinARow = 0;
    
  } else if (classificationResult == 'B') {
    nClassBinARow++;
    nClassAinARow = 0;
  }
  
  fill(0,255,0);
  if (classificationResult == 'A' && nClassAinARow > 100) {
    text("Sure about A", 100, 100);
  } else if (classificationResult == 'B' && nClassBinARow > 100) {
    text("Sure about B", 100, 100);
  } else {
    fill(255, 0, 0);
    text("Not sure...", 100, 100);
  }
  
  console.log("A: " + nClassAinARow);
  console.log("B: " + nClassBinARow);
  
  
  lastClassificationResult = classificationResult;
}

// A function to be called when the model has been loaded
function modelReady() {
  select('#modelStatus').html('Base Model (MobileNet) loaded!');
}

// A function to be called when the video has loaded
function videoReady() {
  select('#videoStatus').html('Video ready!');
}


// Classify the current frame.
function classify() {
  classifier.classify(gotResults);
}

// A util function to create UI buttons
function setupButtons() {
  // When the A button is pressed, add the current frame
  // from the video with a label of "A" to the classifier
  buttonA = select('#ButtonA');
  buttonA.mousePressed(function() {
    classifier.addImage('A');
    select('#amountOfAImages').html(imagesOfA++);
	if (imagesOfA > 20) {
		document.getElementById("train").style.visibility='visible';
	}
  });

  // When the B button is pressed, add the current frame
  // from the video with a label of "B" to the classifier
  buttonB = select('#ButtonB');
  buttonB.mousePressed(function() {
    classifier.addImage('B');
    select('#amountOfBImages').html(imagesOfB++);
  });

  // Train Button
  train = select('#train');
  train.mousePressed(function() {
    classifier.train(function(lossValue) {
      if (lossValue) {
        loss = lossValue;
        select('#loss').html('Loss: ' + loss);
      } else {
        select('#loss').html('Done Training! Final Loss: ' + loss);
		document.getElementById("buttonPredict").style.visibility='visible';
      }
    });
  });

  // Predict Button
  buttonPredict = select('#buttonPredict');
  buttonPredict.mousePressed(classify);
}

// Show the results
function gotResults(err, result) {
  // Display any error
  if (err) {
    console.error(err);
  }
  select('#result').html(result);
  classificationResult = result;
  classify();
}
</script>
</body>

</html>
